<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中文 DOS 遊戲</title>
  <link rel="icon" href="/static/emularity/emularity_color_small.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #212529;
      --card-bg: #ffffff;
      --card-border: #dee2e6;
      --link: #007bff;
      --input-bg: #ffffff;
      --input-text: #212529;
      --input-border: #ced4da;
      --placeholder: #6c757d;
    }
    html[data-theme="dark"] {
      --bg: #121212;
      --text: #e9ecef;
      --card-bg: #1e1e1e;
      --card-border: #2a2a2a;
      --link: #4da3ff;
      --input-bg: #1e1e1e;
      --input-text: #e9ecef;
      --input-border: #3a3a3a;
      --placeholder: #a0a4a8;
    }
    body { padding-top: 1rem; background-color: var(--bg); color: var(--text); }
    a { color: var(--link); }
    .card { background-color: var(--card-bg); border-color: var(--card-border); }
    .game-card { height: 260px; display: flex; flex-direction: column; }
    .cover-wrap { height: 140px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 1px solid var(--card-border); }
    .cover-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .form-control { background-color: var(--input-bg); color: var(--input-text); border-color: var(--input-border); }
    .form-control::placeholder { color: var(--placeholder); }
    .form-control:focus { color: var(--input-text); background-color: var(--input-bg); border-color: var(--link); box-shadow: 0 0 0 .2rem rgba(0,123,255,.25); }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <div class="d-flex align-items-end">
        <h2 class="mb-0">中文 DOS 遊戲</h2>
        <small id="game_count" class="text-muted ml-2 mb-1"></small>
      </div>
      <div class="ml-auto d-flex align-items-center">
        <a id="gh-link" class="btn btn-sm btn-outline-secondary mr-2" href="https://github.com/anomixer/chinese-dos-games-web" target="_blank" rel="noopener" aria-label="GitHub">
          <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.11 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.03 2.2-.82 2.2-.82.44 1.1.16 1.91.08 2.11.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"/>
          </svg>
        </a>
        <div class="btn-group btn-group-sm" role="group">
          <button id="btn-hant" class="btn btn-outline-secondary">繁體</button>
          <button id="btn-hans" class="btn btn-outline-secondary">简体</button>
        </div>
        <button id="btn-theme" class="btn btn-sm btn-outline-secondary ml-2" title="明亮主題">🌞</button>
      </div>
    </div>

    <div class="form-group">
      <input id="q" type="text" class="form-control" placeholder="搜尋（支援繁/簡/英文）" />
    </div>

    <div id="list" class="row"></div>
  </div>

  <script>
    const state = {
      lang: localStorage.getItem('lang') || 'zh-Hant',
      games: {},
    };

    function setLang(l) {
      state.lang = (l === 'zh-Hans' ? 'zh-Hans' : 'zh-Hant');
      localStorage.setItem('lang', state.lang);
      renderList();
    }

    document.getElementById('btn-hant').onclick = () => setLang('zh-Hant');
    document.getElementById('btn-hans').onclick = () => setLang('zh-Hans');
    const themeBtn = document.getElementById('btn-theme');
    if (themeBtn) {
      themeBtn.onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      };
    }

    // Theme
    function applyTheme(t) {
      const theme = (t === 'dark') ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      try { localStorage.setItem('theme', theme); } catch (e) {}
      const b = document.getElementById('btn-theme');
      if (b) {
        b.textContent = (theme === 'dark') ? '🌙' : '🌞';
        b.title = (theme === 'dark') ? '暗色主題' : '明亮主題';
      }
    }
    applyTheme(localStorage.getItem('theme') || 'light');

    async function loadGames() {
      const res = await fetch('/static/games/games.json');
      const data = await res.json();
      state.games = data.games || {};
      updateCount();
      renderList();
    }

    function normalize(str) {
      return (str || '').toLowerCase();
    }

    function renderList() {
      const q = normalize(document.getElementById('q').value);
      const list = document.getElementById('list');
      list.innerHTML = '';
      const keys = Object.keys(state.games);
      keys.forEach((id) => {
        const g = state.games[id];
        const nameMap = g.name || {};
        const nameHant = nameMap['zh-Hant'] || id;
        const nameHans = nameMap['zh-Hans'] || id;
        const nameEn = nameMap['en'] || '';
        const langName = state.lang === 'zh-Hans' ? nameHans : nameHant;
        const hay = `${nameHans}|${nameHant}|${nameEn}|${id}`.toLowerCase();
        if (q && !hay.includes(q)) return;
        const cover = g.coverFilename ? `/static/games/img/${encodeURIComponent(g.identifier)}/${g.coverFilename}` : '/static/img/placeholder.svg';
        const col = document.createElement('div');
        col.className = 'col-6 col-sm-4 col-md-3 mb-3';
        col.innerHTML = `
          <div class="card game-card">
            <div class="cover-wrap">
              <img src="${cover}" alt="cover" onerror="this.onerror=null; this.src='/static/img/placeholder.svg'" />
            </div>
            <div class="card-body p-2 d-flex flex-column">
              <div class="text-truncate mb-2" title="${langName}">${langName}</div>
              <a class="btn btn-sm btn-primary mt-auto" href="/game.html?id=${encodeURIComponent(id)}">開始</a>
            </div>
          </div>
        `;
        list.appendChild(col);
      });
    }

    function updateCount() {
      const countEl = document.getElementById('game_count');
      if (!countEl) return;
      const total = Object.keys(state.games || {}).length;
      // 兩個語系都用「共 X 款」
      countEl.textContent = `共 ${total} 款`;
    }

    document.getElementById('q').addEventListener('input', renderList);
    loadGames();
  </script>
</body>
</html>
