<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>啟動遊戲 - 中文 DOS 遊戲</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/static/emularity/emularity_color_small.png" />
  <link rel="shortcut icon" type="image/png" href="/static/emularity/emularity_color_small.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #212529;
      --card-bg: #ffffff;
      --card-border: #dee2e6;
      --link: #007bff;
    }
    html[data-theme="dark"] {
      --bg: #121212;
      --text: #e9ecef;
      --card-bg: #1e1e1e;
      --card-border: #2a2a2a;
      --link: #4da3ff;
    }
    body { padding: 1rem; background-color: var(--bg); color: var(--text); }
    a { color: var(--link); }

    /* Cards and sidebar readability */
    .card, .card-body { background-color: var(--card-bg); color: var(--text); border-color: var(--card-border); }
    .card-title { color: var(--text); }
    .card .card-link { color: var(--link); }

    /* Keyboard and code tags */
    kbd, code { font-size: 85%; padding: 2px 4px; border-radius: 3px; border: 1px solid #ced4da; }
    kbd { background-color: #f8f9fa; color: #212529; }
    code { background-color: #f8f9fa; color: #d63384; }
    html[data-theme="dark"] kbd { background-color: #2a2f36; color: #e9ecef; border-color: #3a3f46; }
    html[data-theme="dark"] code { background-color: #2a2f36; color: #ffb3c7; border-color: #3a3f46; }

    #screen_container { width: 100%; max-width: 960px; margin: 0 auto; background: #000; }
    canvas#canvas { width: 100%; height: auto; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0" id="game_title">啟動遊戲</h4>
      <div class="ml-auto">
        <div class="btn-group btn-group-sm" role="group">
          <button id="btn-theme" class="btn btn-outline-secondary" title="明亮主題">🌞</button>
          <a class="btn btn-outline-secondary" href="/index.html">回首頁</a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-8">
        <div class="card mb-3">
          <div id="screen_container">
            <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
          </div>
          <div class="card-body">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-light" onclick="htmlFullscreen()">網頁全螢幕</button>
              <button class="btn btn-light" onclick="emulator && emulator.requestFullScreen && emulator.requestFullScreen()">全螢幕遊戲</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-4" id="sidebar">
        <!-- 右側動態資訊：操作、連結、（可選）作弊 -->
      </div>
    </div>
  </div>

  <!-- Emularity deps -->
  <script src="/static/emularity/es6-promise.js"></script>
  <script src="/static/emularity/browserfs.min.js"></script>
  <script src="/static/emularity/loader.js"></script>
  <!-- Config: 指定 Workers 網域（例如 https://xxx.workers.dev）；留空代表使用同源 /stream -->
  <script src="/static/js/config.js"></script>

  <script>
    // Theme toggle
    function applyTheme(t) {
      const theme = (t === 'dark') ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      try { localStorage.setItem('theme', theme); } catch (e) {}
      const b = document.getElementById('btn-theme');
      if (b) {
        b.textContent = (theme === 'dark') ? '🌙' : '🌞';
        b.title = (theme === 'dark') ? '暗色主題' : '明亮主題';
      }
    }
    applyTheme(localStorage.getItem('theme') || 'light');
    document.addEventListener('DOMContentLoaded', () => {
      const b = document.getElementById('btn-theme');
      if (b) b.onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      };
    });

    // Simple fullscreen for the page container
    function htmlFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const lang = localStorage.getItem('lang') || 'zh-Hant';
    let emulator = null;

    if (!id) {
      alert('缺少參數 id');
    } else {
      boot();
    }

    async function boot() {
      // 讀取資料
      const res = await fetch('/static/games/games.json');
      const data = await res.json();
      const game = (data.games || {})[id];
      if (!game) {
        alert('找不到此遊戲：' + id);
        return;
      }
      const title = (game.name && (game.name[lang] || game.name['zh-Hant'] || id)) || id;
      document.getElementById('game_title').textContent = title;
      renderSidebar(game);

      const sha = (game.sha256 || '').slice(0, 8) || '0';
      const base = (window.CDG_STREAM_ORIGIN || '').replace(/\/$/, '');
      const zipUrl = `${base}/stream/${encodeURIComponent(id)}.zip?v=${sha}`; // 可跨網域（workers.dev）或同源

      // 決定磁碟類型（預設 hdd）
      const driveType = game.cdrom ? 'cdrom' : (game.floppy ? 'floppy' : 'hdd');

      // 啟動 Emularity
      window.emulator = emulator = new Emulator(
        document.querySelector('#canvas'),
        null,
        new DosBoxLoader(
          DosBoxLoader.emulatorJS('/static/emularity/dosbox/dosbox-sync.js'),
          DosBoxLoader.locateAdditionalEmulatorJS(locateAdditionalFiles),
          DosBoxLoader.nativeResolution(640, 480),
          DosBoxLoader.fileSystemKey(id),
          DosBoxLoader.mountZip('c', DosBoxLoader.fetchFile('Game File', zipUrl), driveType),
          DosBoxLoader.startExe(game.executable)
        )
      );
      // 顯示 Emularity 啟動畫面小圖示（與 Flask 版本一致）
      if (emulator && emulator.setSplashImage) {
        emulator.setSplashImage('/static/emularity/emularity_color_small.png');
      }
      emulator.start({ waitAfterDownloading: true });
    }

    function locateAdditionalFiles(filename) {
      if (filename === 'dosbox.html.mem') {
        return '/static/emularity/dosbox/dosbox-sync.mem';
      } else {
        return '/static/emularity/dosbox/dosbox-sync.mem' + filename;
      }
    }
    function renderSidebar(game) {
      const box = document.getElementById('sidebar');
      if (!box) return;
      const parts = [];
      // 封面（若無則使用預設圖）
      (function(){
        const ident = (game.identifier || id || '').toString();
        const hasCover = !!game.coverFilename;
        const cover = hasCover ? `/static/games/img/${encodeURIComponent(ident)}/${game.coverFilename}` : '/static/img/placeholder.svg';
        parts.push(`
          <div class="card mb-3">
            <img class="card-img-top" src="${cover}" alt="cover" onerror="this.onerror=null; this.src='/static/img/placeholder.svg'" />
          </div>
        `);
      })();
      // 操作（keymaps）
      if (game.keymaps && typeof game.keymaps === 'object' && Object.keys(game.keymaps).length > 0) {
        const ops = Object.entries(game.keymaps).map(([k,v]) => `<div><kbd>${k}</kbd> ${v}</div>`).join('');
        parts.push(`
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${lang === 'zh-Hans' ? '操作' : '操作'}</h5>
              ${ops}
            </div>
          </div>
        `);
      }
      // 連結（links）
      if (game.links && typeof game.links === 'object' && Object.keys(game.links).length > 0) {
        const links = Object.entries(game.links).map(([name,url]) => `<div><a class="card-link" href="${url}" target="_blank" rel="noopener">${name}</a></div>`).join('');
        parts.push(`
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${lang === 'zh-Hans' ? '链接' : '連結'}</h5>
              ${links}
            </div>
          </div>
        `);
      }
      // 可選：作弊（cheats）
      if (game.cheats && typeof game.cheats === 'object' && Object.keys(game.cheats).length > 0) {
        const cheats = Object.entries(game.cheats).map(([k,v]) => `<div><code>${k}</code> ${v}</div>`).join('');
        parts.push(`
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${lang === 'zh-Hans' ? '作弊' : '作弊'}</h5>
              ${cheats}
            </div>
          </div>
        `);
      }
      box.innerHTML = parts.join('');
    }
  </script>
</body>
</html>
