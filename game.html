<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>啟動遊戲 - 中文 DOS 遊戲</title>
  <link rel="icon" href="/static/emularity/emularity_color_small.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <style>
    body { padding: 1rem; }
    #screen_container { width: 100%; max-width: 960px; margin: 0 auto; background: #000; }
    canvas#canvas { width: 100%; height: auto; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0" id="game_title">啟動遊戲</h4>
      <div class="ml-auto">
        <a class="btn btn-sm btn-outline-secondary" href="/index.html">回首頁</a>
      </div>
    </div>

    <div class="card mb-3">
      <div id="screen_container">
        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
      </div>
      <div class="card-body">
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-light" onclick="htmlFullscreen()">網頁全螢幕</button>
          <button class="btn btn-light" onclick="emulator && emulator.requestFullScreen && emulator.requestFullScreen()">全螢幕遊戲</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Emularity deps -->
  <script src="/static/emularity/es6-promise.js"></script>
  <script src="/static/emularity/browserfs.min.js"></script>
  <script src="/static/emularity/loader.js"></script>
  <!-- Config: 指定 Workers 網域（例如 https://xxx.workers.dev）；留空代表使用同源 /stream -->
  <script src="/static/js/config.js"></script>

  <script>
    // Simple fullscreen for the page container
    function htmlFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const lang = localStorage.getItem('lang') || 'zh-Hant';
    let emulator = null;

    if (!id) {
      alert('缺少參數 id');
    } else {
      boot();
    }

    async function boot() {
      // 讀取資料
      const res = await fetch('/static/games/games.json');
      const data = await res.json();
      const game = (data.games || {})[id];
      if (!game) {
        alert('找不到此遊戲：' + id);
        return;
      }
      const title = (game.name && (game.name[lang] || game.name['zh-Hant'] || id)) || id;
      document.getElementById('game_title').textContent = title;

      const sha = (game.sha256 || '').slice(0, 8) || '0';
      const base = (window.CDG_STREAM_ORIGIN || '').replace(/\/$/, '');
      const zipUrl = `${base}/stream/${encodeURIComponent(id)}.zip?v=${sha}`; // 可跨網域（workers.dev）或同源

      // 決定磁碟類型（預設 hdd）
      const driveType = game.cdrom ? 'cdrom' : (game.floppy ? 'floppy' : 'hdd');

      // 啟動 Emularity
      window.emulator = emulator = new Emulator(
        document.querySelector('#canvas'),
        null,
        new DosBoxLoader(
          DosBoxLoader.emulatorJS('/static/emularity/dosbox/dosbox-sync.js'),
          DosBoxLoader.locateAdditionalEmulatorJS(locateAdditionalFiles),
          DosBoxLoader.nativeResolution(640, 480),
          DosBoxLoader.fileSystemKey(id),
          DosBoxLoader.mountZip('c', DosBoxLoader.fetchFile('Game File', zipUrl), driveType),
          DosBoxLoader.startExe(game.executable)
        )
      );
      emulator.start({ waitAfterDownloading: true });
    }

    function locateAdditionalFiles(filename) {
      if (filename === 'dosbox.html.mem') {
        return '/static/emularity/dosbox/dosbox-sync.mem';
      } else {
        return '/static/emularity/dosbox/dosbox-sync.mem' + filename;
      }
    }
  </script>
</body>
</html>
