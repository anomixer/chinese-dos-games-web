<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•Ÿå‹•éŠæˆ² - ä¸­æ–‡ DOS éŠæˆ²</title>
  <link rel="icon" href="/static/emularity/emularity_color_small.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #212529;
      --card-bg: #ffffff;
      --card-border: #dee2e6;
      --link: #007bff;
    }
    html[data-theme="dark"] {
      --bg: #121212;
      --text: #e9ecef;
      --card-bg: #1e1e1e;
      --card-border: #2a2a2a;
      --link: #4da3ff;
    }
    body { padding: 1rem; background-color: var(--bg); color: var(--text); }
    a { color: var(--link); }
    #screen_container { width: 100%; max-width: 960px; margin: 0 auto; background: #000; }
    canvas#canvas { width: 100%; height: auto; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0" id="game_title">å•Ÿå‹•éŠæˆ²</h4>
      <div class="ml-auto">
        <div class="btn-group btn-group-sm" role="group">
          <button id="btn-theme" class="btn btn-outline-secondary" title="æ˜äº®ä¸»é¡Œ">ğŸŒ</button>
          <a class="btn btn-outline-secondary" href="/index.html">å›é¦–é </a>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div id="screen_container">
        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
      </div>
      <div class="card-body">
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-light" onclick="htmlFullscreen()">ç¶²é å…¨è¢å¹•</button>
          <button class="btn btn-light" onclick="emulator && emulator.requestFullScreen && emulator.requestFullScreen()">å…¨è¢å¹•éŠæˆ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Emularity deps -->
  <script src="/static/emularity/es6-promise.js"></script>
  <script src="/static/emularity/browserfs.min.js"></script>
  <script src="/static/emularity/loader.js"></script>
  <!-- Config: æŒ‡å®š Workers ç¶²åŸŸï¼ˆä¾‹å¦‚ https://xxx.workers.devï¼‰ï¼›ç•™ç©ºä»£è¡¨ä½¿ç”¨åŒæº /stream -->
  <script src="/static/js/config.js"></script>

  <script>
    // Theme toggle
    function applyTheme(t) {
      const theme = (t === 'dark') ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      try { localStorage.setItem('theme', theme); } catch (e) {}
      const b = document.getElementById('btn-theme');
      if (b) {
        b.textContent = (theme === 'dark') ? 'ğŸŒ™' : 'ğŸŒ';
        b.title = (theme === 'dark') ? 'æš—è‰²ä¸»é¡Œ' : 'æ˜äº®ä¸»é¡Œ';
      }
    }
    applyTheme(localStorage.getItem('theme') || 'light');
    document.addEventListener('DOMContentLoaded', () => {
      const b = document.getElementById('btn-theme');
      if (b) b.onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      };
    });

    // Simple fullscreen for the page container
    function htmlFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const lang = localStorage.getItem('lang') || 'zh-Hant';
    let emulator = null;

    if (!id) {
      alert('ç¼ºå°‘åƒæ•¸ id');
    } else {
      boot();
    }

    async function boot() {
      // è®€å–è³‡æ–™
      const res = await fetch('/static/games/games.json');
      const data = await res.json();
      const game = (data.games || {})[id];
      if (!game) {
        alert('æ‰¾ä¸åˆ°æ­¤éŠæˆ²ï¼š' + id);
        return;
      }
      const title = (game.name && (game.name[lang] || game.name['zh-Hant'] || id)) || id;
      document.getElementById('game_title').textContent = title;

      const sha = (game.sha256 || '').slice(0, 8) || '0';
      const base = (window.CDG_STREAM_ORIGIN || '').replace(/\/$/, '');
      const zipUrl = `${base}/stream/${encodeURIComponent(id)}.zip?v=${sha}`; // å¯è·¨ç¶²åŸŸï¼ˆworkers.devï¼‰æˆ–åŒæº

      // æ±ºå®šç£ç¢Ÿé¡å‹ï¼ˆé è¨­ hddï¼‰
      const driveType = game.cdrom ? 'cdrom' : (game.floppy ? 'floppy' : 'hdd');

      // å•Ÿå‹• Emularity
      window.emulator = emulator = new Emulator(
        document.querySelector('#canvas'),
        null,
        new DosBoxLoader(
          DosBoxLoader.emulatorJS('/static/emularity/dosbox/dosbox-sync.js'),
          DosBoxLoader.locateAdditionalEmulatorJS(locateAdditionalFiles),
          DosBoxLoader.nativeResolution(640, 480),
          DosBoxLoader.fileSystemKey(id),
          DosBoxLoader.mountZip('c', DosBoxLoader.fetchFile('Game File', zipUrl), driveType),
          DosBoxLoader.startExe(game.executable)
        )
      );
      emulator.start({ waitAfterDownloading: true });
    }

    function locateAdditionalFiles(filename) {
      if (filename === 'dosbox.html.mem') {
        return '/static/emularity/dosbox/dosbox-sync.mem';
      } else {
        return '/static/emularity/dosbox/dosbox-sync.mem' + filename;
      }
    }
  </script>
</body>
</html>
