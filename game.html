<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•Ÿå‹•éŠæˆ² - ä¸­æ–‡ DOS éŠæˆ²</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/static/emularity/emularity_color_small.png" />
  <link rel="shortcut icon" type="image/png" href="/static/emularity/emularity_color_small.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #212529;
      --card-bg: #ffffff;
      --card-border: #dee2e6;
      --link: #007bff;
    }
    html[data-theme="dark"] {
      --bg: #121212;
      --text: #e9ecef;
      --card-bg: #1e1e1e;
      --card-border: #2a2a2a;
      --link: #4da3ff;
    }
    body { padding: 1rem; background-color: var(--bg); color: var(--text); }
    a { color: var(--link); }

    /* Cards and sidebar readability */
    .card, .card-body { background-color: var(--card-bg); color: var(--text); border-color: var(--card-border); }
    .card-title { color: var(--text); }
    .card .card-link { color: var(--link); }

    /* Keyboard and code tags */
    kbd, code { font-size: 85%; padding: 2px 4px; border-radius: 3px; border: 1px solid #ced4da; }
    kbd { background-color: #f8f9fa; color: #212529; }
    code { background-color: #f8f9fa; color: #d63384; }
    html[data-theme="dark"] kbd { background-color: #2a2f36; color: #e9ecef; border-color: #3a3f46; }
    html[data-theme="dark"] code { background-color: #2a2f36; color: #ffb3c7; border-color: #3a3f46; }

    #screen_container { width: 100%; max-width: 960px; margin: 0 auto; background: #000; }
    canvas#canvas { width: 100%; height: auto; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0" id="game_title">å•Ÿå‹•éŠæˆ²</h4>
      <div class="ml-auto">
        <div class="btn-group btn-group-sm" role="group">
          <button id="btn-theme" class="btn btn-outline-secondary" title="æ˜äº®ä¸»é¡Œ">ğŸŒ</button>
          <a class="btn btn-outline-secondary" href="/index.html">å›é¦–é </a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-8">
        <div class="card mb-3">
          <div id="screen_container">
            <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
          </div>
          <div class="card-body">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-light" onclick="htmlFullscreen()">ç¶²é å…¨è¢å¹•</button>
              <button class="btn btn-light" onclick="emulator && emulator.requestFullScreen && emulator.requestFullScreen()">å…¨è¢å¹•éŠæˆ²</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-4" id="sidebar">
        <!-- å³å´å‹•æ…‹è³‡è¨Šï¼šæ“ä½œã€é€£çµã€ï¼ˆå¯é¸ï¼‰ä½œå¼Š -->
      </div>
    </div>
  </div>

  <!-- Emularity deps -->
  <script src="/static/emularity/es6-promise.js"></script>
  <script src="/static/emularity/browserfs.min.js"></script>
  <script src="/static/emularity/loader.js"></script>
  <!-- Config: æŒ‡å®š Workers ç¶²åŸŸï¼ˆä¾‹å¦‚ https://xxx.workers.devï¼‰ï¼›ç•™ç©ºä»£è¡¨ä½¿ç”¨åŒæº /stream -->
  <script src="/static/js/config.js"></script>

  <script>
    // Theme toggle
    function applyTheme(t) {
      const theme = (t === 'dark') ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      try { localStorage.setItem('theme', theme); } catch (e) {}
      const b = document.getElementById('btn-theme');
      if (b) {
        b.textContent = (theme === 'dark') ? 'ğŸŒ™' : 'ğŸŒ';
        b.title = (theme === 'dark') ? 'æš—è‰²ä¸»é¡Œ' : 'æ˜äº®ä¸»é¡Œ';
      }
    }
    applyTheme(localStorage.getItem('theme') || 'light');
    document.addEventListener('DOMContentLoaded', () => {
      const b = document.getElementById('btn-theme');
      if (b) b.onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      };
    });

    // Simple fullscreen for the page container
    function htmlFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const lang = localStorage.getItem('lang') || 'zh-Hant';
    let emulator = null;

    if (!id) {
      alert('ç¼ºå°‘åƒæ•¸ id');
    } else {
      boot();
    }

    async function boot() {
      // è®€å–è³‡æ–™
      const res = await fetch('/static/games/games.json');
      const data = await res.json();
      const game = (data.games || {})[id];
      if (!game) {
        alert('æ‰¾ä¸åˆ°æ­¤éŠæˆ²ï¼š' + id);
        return;
      }
      const title = (game.name && (game.name[lang] || game.name['zh-Hant'] || id)) || id;
      document.getElementById('game_title').textContent = title;
      renderSidebar(game);

      const sha = (game.sha256 || '').slice(0, 8) || '0';
      const base = (window.CDG_STREAM_ORIGIN || '').replace(/\/$/, '');
      const zipUrl = `${base}/stream/${encodeURIComponent(id)}.zip?v=${sha}`; // å¯è·¨ç¶²åŸŸï¼ˆworkers.devï¼‰æˆ–åŒæº

      // æ±ºå®šç£ç¢Ÿé¡å‹ï¼ˆé è¨­ hddï¼‰
      const driveType = game.cdrom ? 'cdrom' : (game.floppy ? 'floppy' : 'hdd');

      // å•Ÿå‹• Emularity
      window.emulator = emulator = new Emulator(
        document.querySelector('#canvas'),
        null,
        new DosBoxLoader(
          DosBoxLoader.emulatorJS('/static/emularity/dosbox/dosbox-sync.js'),
          DosBoxLoader.locateAdditionalEmulatorJS(locateAdditionalFiles),
          DosBoxLoader.nativeResolution(640, 480),
          DosBoxLoader.fileSystemKey(id),
          DosBoxLoader.mountZip('c', DosBoxLoader.fetchFile('Game File', zipUrl), driveType),
          DosBoxLoader.startExe(game.executable)
        )
      );
      // é¡¯ç¤º Emularity å•Ÿå‹•ç•«é¢å°åœ–ç¤ºï¼ˆèˆ‡ Flask ç‰ˆæœ¬ä¸€è‡´ï¼‰
      if (emulator && emulator.setSplashImage) {
        emulator.setSplashImage('/static/emularity/emularity_color_small.png');
      }
      emulator.start({ waitAfterDownloading: true });
    }

    function locateAdditionalFiles(filename) {
      if (filename === 'dosbox.html.mem') {
        return '/static/emularity/dosbox/dosbox-sync.mem';
      } else {
        return '/static/emularity/dosbox/dosbox-sync.mem' + filename;
      }
    }
    function renderSidebar(game) {
      const box = document.getElementById('sidebar');
      if (!box) return;
      const parts = [];
      // å°é¢ï¼ˆè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­åœ–ï¼‰
      (function(){
        const ident = (game.identifier || id || '').toString();
        const hasCover = !!game.coverFilename;
        const cover = hasCover ? `/static/games/img/${encodeURIComponent(ident)}/${game.coverFilename}` : '/static/img/placeholder.svg';
        parts.push(`
          <div class="card mb-3">
            <img class="card-img-top" src="${cover}" alt="cover" onerror="this.onerror=null; this.src='/static/img/placeholder.svg'" />
          </div>
        `);
      })();
      // æ“ä½œï¼ˆkeymapsï¼‰
      if (game.keymaps && typeof game.keymaps === 'object' && Object.keys(game.keymaps).length > 0) {
        const ops = Object.entries(game.keymaps).map(([k,v]) => `<div><kbd>${k}</kbd> ${v}</div>`).join('');
        parts.push(`
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${lang === 'zh-Hans' ? 'æ“ä½œ' : 'æ“ä½œ'}</h5>
              ${ops}
            </div>
          </div>
        `);
      }
      // é€£çµï¼ˆlinksï¼‰
      if (game.links && typeof game.links === 'object' && Object.keys(game.links).length > 0) {
        const links = Object.entries(game.links).map(([name,url]) => `<div><a class="card-link" href="${url}" target="_blank" rel="noopener">${name}</a></div>`).join('');
        parts.push(`
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${lang === 'zh-Hans' ? 'é“¾æ¥' : 'é€£çµ'}</h5>
              ${links}
            </div>
          </div>
        `);
      }
      // å¯é¸ï¼šä½œå¼Šï¼ˆcheatsï¼‰
      if (game.cheats && typeof game.cheats === 'object' && Object.keys(game.cheats).length > 0) {
        const cheats = Object.entries(game.cheats).map(([k,v]) => `<div><code>${k}</code> ${v}</div>`).join('');
        parts.push(`
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">${lang === 'zh-Hans' ? 'ä½œå¼Š' : 'ä½œå¼Š'}</h5>
              ${cheats}
            </div>
          </div>
        `);
      }
      box.innerHTML = parts.join('');
    }
  </script>
</body>
</html>
